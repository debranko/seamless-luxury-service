<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OBEDIO SmartButton — 3D Explorer</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600&family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&display=swap" rel="stylesheet">
  <style>
    :root {
      --gold: #c9a962;
      --gold-light: #dfc07a;
      --black: #080705;
      --cream: #f0ebe0;
      --muted: #6a6560;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #050403;
      color: var(--cream);
      font-family: 'Cormorant Garamond', serif;
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
    }
    canvas { display: block; }

    /* Loading */
    .loading-screen {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      background: #050403;
      z-index: 1000;
      transition: opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .loading-screen.hidden { opacity: 0; pointer-events: none; }
    .loading-logo {
      font-family: 'Cinzel', serif;
      font-size: 18px;
      letter-spacing: 12px;
      color: var(--gold);
      opacity: 0;
      animation: fadeInUp 1s 0.3s forwards;
      margin-bottom: 40px;
    }
    .loading-bar-track {
      width: 200px; height: 1px;
      background: rgba(201,169,98,0.15);
      position: relative;
      overflow: hidden;
    }
    .loading-bar-fill {
      position: absolute; left: 0; top: 0;
      height: 100%;
      background: var(--gold);
      width: 0%;
      transition: width 0.3s ease;
    }
    .loading-pct {
      margin-top: 16px;
      font-size: 11px;
      letter-spacing: 4px;
      color: var(--muted);
      opacity: 0;
      animation: fadeInUp 1s 0.6s forwards;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* UI Controls */
    .viewer-header {
      position: fixed; top: 0; left: 0; right: 0;
      display: flex; justify-content: space-between; align-items: center;
      padding: 30px 40px;
      z-index: 10;
      pointer-events: none;
    }
    .viewer-brand {
      font-family: 'Cinzel', serif;
      font-size: 11px;
      letter-spacing: 6px;
      color: var(--gold);
      opacity: 0.5;
      transition: opacity 0.3s;
    }
    .viewer-brand:hover { opacity: 0.8; }
    .back-link {
      font-size: 13px;
      color: var(--muted);
      text-decoration: none;
      pointer-events: auto;
      transition: color 0.3s;
      letter-spacing: 2px;
    }
    .back-link:hover { color: var(--gold); }

    /* Material Selector */
    .material-panel {
      position: fixed;
      right: 40px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 16px;
      z-index: 10;
    }
    .mat-swatch {
      width: 36px; height: 36px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    .mat-swatch:hover { transform: scale(1.2); }
    .mat-swatch.active {
      border-color: var(--gold);
      box-shadow: 0 0 20px rgba(201,169,98,0.3);
    }
    .mat-swatch .tooltip {
      position: absolute;
      right: 52px;
      top: 50%;
      transform: translateY(-50%);
      white-space: nowrap;
      font-size: 11px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--gold);
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    .mat-swatch:hover .tooltip { opacity: 0.7; }
    .mat-brass { background: linear-gradient(135deg, #dfc07a 0%, #8b7335 100%); }
    .mat-steel { background: linear-gradient(135deg, #d4d4d4 0%, #707070 100%); }
    .mat-pvd { background: linear-gradient(135deg, #2a2a2a 0%, #0a0a0a 100%); }
    .mat-rose { background: linear-gradient(135deg, #d4956a 0%, #8b5e3c 100%); }

    /* Bottom UI */
    .viewer-footer {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      text-align: center;
      padding: 30px 40px;
      z-index: 10;
      pointer-events: none;
    }
    .model-name {
      font-family: 'Cinzel', serif;
      font-size: 13px;
      letter-spacing: 6px;
      text-transform: uppercase;
      color: var(--gold);
      opacity: 0.5;
      margin-bottom: 6px;
    }
    .model-subtitle {
      font-size: 14px;
      font-style: italic;
      color: var(--muted);
      opacity: 0.5;
    }
    .interaction-hint {
      font-size: 12px;
      color: var(--muted);
      opacity: 0.4;
      margin-top: 10px;
      transition: opacity 0.8s;
    }
    .interaction-hint.fade { opacity: 0; }

    /* Reset View button */
    .reset-btn {
      position: fixed;
      bottom: 100px;
      right: 40px;
      z-index: 10;
      background: none;
      border: 1px solid rgba(201,169,98,0.2);
      color: var(--muted);
      font-family: 'Cormorant Garamond', serif;
      font-size: 12px;
      letter-spacing: 3px;
      padding: 8px 18px;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
    }
    .reset-btn:hover {
      border-color: var(--gold);
      color: var(--gold);
    }

    /* Mobile adjustments */
    @media (max-width: 768px) {
      .material-panel {
        right: auto;
        left: 50%;
        top: auto;
        bottom: 100px;
        transform: translateX(-50%);
        flex-direction: row;
      }
      .mat-swatch .tooltip { display: none; }
      .viewer-header { padding: 20px; }
      .viewer-footer { padding: 20px; }
      .reset-btn { bottom: 155px; right: 20px; }
    }
  </style>
</head>
<body>

  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">OBEDIO</div>
    <div class="loading-bar-track">
      <div class="loading-bar-fill" id="loadingBar"></div>
    </div>
    <div class="loading-pct" id="loadingPct">LOADING</div>
  </div>

  <!-- Header -->
  <div class="viewer-header">
    <div class="viewer-brand">OBEDIO</div>
    <a href="index.html" class="back-link">← Back to Site</a>
  </div>

  <!-- Material Selector -->
  <div class="material-panel" id="materialPanel">
    <div class="mat-swatch mat-brass active" data-material="brass" onclick="setMaterial('brass')">
      <span class="tooltip">Polished Brass</span>
    </div>
    <div class="mat-swatch mat-steel" data-material="steel" onclick="setMaterial('steel')">
      <span class="tooltip">316L Steel</span>
    </div>
    <div class="mat-swatch mat-pvd" data-material="pvd" onclick="setMaterial('pvd')">
      <span class="tooltip">Black PVD</span>
    </div>
    <div class="mat-swatch mat-rose" data-material="rose" onclick="setMaterial('rose')">
      <span class="tooltip">Rose Gold</span>
    </div>
  </div>

  <!-- Reset -->
  <button class="reset-btn" onclick="resetView()">Reset View</button>

  <!-- Footer -->
  <div class="viewer-footer">
    <div class="model-name">SmartButton — Top Plate</div>
    <div class="model-subtitle">CNC machined from solid brass</div>
    <div class="interaction-hint" id="hint">Drag to rotate · Scroll to zoom · Double-click to reset</div>
  </div>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
    }
  }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
    import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';

    /* ───── Scene Setup ───── */
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050403);
    scene.fog = new THREE.FogExp2(0x050403, 0.04);

    /* ───── Camera ───── */
    const camera = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 0.01, 200);
    camera.position.set(4, 6, 6);

    /* ───── Renderer ───── */
    const renderer = new THREE.WebGLRenderer({
      antialias: true,
      powerPreference: 'high-performance',
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.0;
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    document.body.appendChild(renderer.domElement);

    /* ───── Environment (studio reflections) ───── */
    const pmremGenerator = new THREE.PMREMGenerator(renderer);
    pmremGenerator.compileEquirectangularShader();
    const roomEnv = pmremGenerator.fromScene(new RoomEnvironment(), 0.04).texture;
    scene.environment = roomEnv;

    /* ───── Orbit Controls ───── */
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.06;
    controls.autoRotate = true;
    controls.autoRotateSpeed = 0.8;
    controls.minDistance = 2;
    controls.maxDistance = 18;
    controls.maxPolarAngle = Math.PI * 0.75;
    controls.target.set(0, 0, 0);

    /* ───── Lighting ───── */
    // Key light — warm, top-left
    const keyLight = new THREE.SpotLight(0xffeedd, 80, 30, Math.PI / 5, 0.5, 1);
    keyLight.position.set(-6, 10, 6);
    keyLight.castShadow = true;
    keyLight.shadow.mapSize.set(1024, 1024);
    keyLight.shadow.bias = -0.001;
    scene.add(keyLight);
    scene.add(keyLight.target);

    // Fill light — cool blue from right
    const fillLight = new THREE.SpotLight(0xaabbdd, 25, 25, Math.PI / 4, 0.6, 1);
    fillLight.position.set(6, 5, -4);
    scene.add(fillLight);

    // Rim light — gold accent from behind
    const rimLight = new THREE.SpotLight(0xc9a962, 40, 20, Math.PI / 6, 0.4, 1);
    rimLight.position.set(0, 4, -8);
    scene.add(rimLight);

    // Top fill
    const topLight = new THREE.PointLight(0xffffff, 15, 20, 1);
    topLight.position.set(0, 10, 0);
    scene.add(topLight);

    // Subtle ambient
    scene.add(new THREE.AmbientLight(0x1a1510, 1.5));

    /* ───── Ground ───── */
    const groundGeom = new THREE.CircleGeometry(15, 64);
    const groundMat = new THREE.MeshStandardMaterial({
      color: 0x080705,
      roughness: 0.7,
      metalness: 0.2,
    });
    const ground = new THREE.Mesh(groundGeom, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.position.y = -0.6;
    ground.receiveShadow = true;
    scene.add(ground);

    // Ground glow ring
    const glowGeom = new THREE.RingGeometry(2.8, 3.5, 64);
    const glowMat = new THREE.MeshBasicMaterial({
      color: 0xc9a962,
      transparent: true,
      opacity: 0.04,
      side: THREE.DoubleSide,
    });
    const glowRing = new THREE.Mesh(glowGeom, glowMat);
    glowRing.rotation.x = -Math.PI / 2;
    glowRing.position.y = -0.58;
    scene.add(glowRing);

    /* ───── Materials ───── */
    const matLib = {
      brass: new THREE.MeshPhysicalMaterial({
        color: 0xc9a962,
        roughness: 0.12,
        metalness: 1.0,
        clearcoat: 0.4,
        clearcoatRoughness: 0.15,
        envMapIntensity: 2.0,
      }),
      steel: new THREE.MeshPhysicalMaterial({
        color: 0xcccccc,
        roughness: 0.15,
        metalness: 1.0,
        clearcoat: 0.3,
        clearcoatRoughness: 0.1,
        envMapIntensity: 1.8,
      }),
      pvd: new THREE.MeshPhysicalMaterial({
        color: 0x151515,
        roughness: 0.08,
        metalness: 1.0,
        clearcoat: 0.6,
        clearcoatRoughness: 0.05,
        envMapIntensity: 2.5,
      }),
      rose: new THREE.MeshPhysicalMaterial({
        color: 0xd4956a,
        roughness: 0.13,
        metalness: 1.0,
        clearcoat: 0.35,
        clearcoatRoughness: 0.12,
        envMapIntensity: 2.0,
      }),
    };

    let model = null;
    let activeMat = 'brass';

    /* ───── Load OBJ ───── */
    const loader = new OBJLoader();
    const barEl = document.getElementById('loadingBar');
    const pctEl = document.getElementById('loadingPct');

    loader.load(
      'models/Top_Part_Final.obj',
      (obj) => {
        // Compute bounding box
        const box = new THREE.Box3().setFromObject(obj);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());

        // Identify axes: the smallest range is thickness
        const dims = [
          { axis: 'x', size: size.x },
          { axis: 'y', size: size.y },
          { axis: 'z', size: size.z },
        ].sort((a, b) => a.size - b.size);

        const thicknessAxis = dims[0].axis; // thinnest = thickness
        const widthAxis = dims[2].axis;     // widest
        const depthAxis = dims[1].axis;

        // Center at origin
        obj.position.sub(center);

        // Scale so the widest dimension = 5 units
        const mainScale = 5 / dims[2].size;
        obj.scale.setScalar(mainScale);

        // Exaggerate thickness for visual presence
        // Actual ratio might be 0.15:8.79 = 0.017, scale up thickness to ~0.3:5 ratio
        const thicknessRatio = dims[0].size / dims[2].size;
        const targetThicknessRatio = 0.08; // visible but not chunky
        const thicknessBoost = targetThicknessRatio / thicknessRatio;

        if (thicknessAxis === 'x') obj.scale.x *= thicknessBoost;
        else if (thicknessAxis === 'y') obj.scale.y *= thicknessBoost;
        else obj.scale.z *= thicknessBoost;

        // Rotate so the TOP face of the plate faces UP (Y-up in Three.js)
        // The thickness axis should align with Y
        // In our OBJ: Y is thickness (range ~0.15), X is width (~8.79), Z is depth (~6.93)
        // Y is already up in Three.js — no rotation needed for this model
        // But check: if thickness is Y, it's already correct

        // Apply smooth normals
        obj.traverse((child) => {
          if (child.isMesh) {
            child.geometry.computeVertexNormals();
            child.material = matLib.brass;
            child.castShadow = true;
            child.receiveShadow = true;
          }
        });

        scene.add(obj);
        model = obj;

        // Set camera target slightly above center
        controls.target.set(0, 0, 0);

        // Reveal
        setTimeout(() => {
          document.getElementById('loadingScreen').classList.add('hidden');
          // Fade hint after 5 seconds
          setTimeout(() => {
            document.getElementById('hint').classList.add('fade');
          }, 5000);
        }, 600);
      },
      (xhr) => {
        if (xhr.lengthComputable) {
          const pct = Math.round((xhr.loaded / xhr.total) * 100);
          barEl.style.width = pct + '%';
          pctEl.textContent = pct + '%';
        }
      },
      (err) => {
        console.error('OBJ load error:', err);
        pctEl.textContent = 'ERROR';
      }
    );

    /* ───── Material Switch ───── */
    window.setMaterial = function(name) {
      activeMat = name;
      if (model) {
        model.traverse((child) => {
          if (child.isMesh) child.material = matLib[name];
        });
      }
      document.querySelectorAll('.mat-swatch').forEach(el => {
        el.classList.toggle('active', el.dataset.material === name);
      });
      // Adjust ground glow color
      if (name === 'pvd') glowMat.color.setHex(0x888888);
      else if (name === 'steel') glowMat.color.setHex(0xaaaacc);
      else if (name === 'rose') glowMat.color.setHex(0xd4956a);
      else glowMat.color.setHex(0xc9a962);
    };

    /* ───── Reset View ───── */
    window.resetView = function() {
      controls.autoRotate = true;
      // Smooth reset
      const startPos = camera.position.clone();
      const endPos = new THREE.Vector3(4, 6, 6);
      const startTarget = controls.target.clone();
      const endTarget = new THREE.Vector3(0, 0, 0);
      const duration = 1000;
      const start = performance.now();

      function ease(t) { return t < 0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2, 3)/2; }

      function animateReset(now) {
        const t = Math.min((now - start) / duration, 1);
        const e = ease(t);
        camera.position.lerpVectors(startPos, endPos, e);
        controls.target.lerpVectors(startTarget, endTarget, e);
        if (t < 1) requestAnimationFrame(animateReset);
      }
      requestAnimationFrame(animateReset);
    };

    // Double-click to reset
    renderer.domElement.addEventListener('dblclick', () => resetView());

    // Pause auto-rotate on drag, resume after 4s
    let resumeTimer;
    controls.addEventListener('start', () => {
      controls.autoRotate = false;
      clearTimeout(resumeTimer);
    });
    controls.addEventListener('end', () => {
      clearTimeout(resumeTimer);
      resumeTimer = setTimeout(() => { controls.autoRotate = true; }, 4000);
    });

    /* ───── Render Loop ───── */
    const clock = new THREE.Clock();
    function animate() {
      requestAnimationFrame(animate);
      controls.update();

      // Subtle glow pulse
      const t = clock.getElapsedTime();
      glowMat.opacity = 0.03 + Math.sin(t * 0.8) * 0.015;

      renderer.render(scene, camera);
    }
    animate();

    /* ───── Resize ───── */
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
